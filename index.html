<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>商品与订单管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 基础样式保持不变 */
        :root {
            --primary: #4A90E2;
            --primary-dark: #357ABD;
            --secondary: #50C878;
            --danger: #FF6B6B;
            --warning: #FFD166;
            --info: #6A7FDB;
            --bg: #f5f8fa;
            --card-bg: #fff;
            --border: #e1e5e9;
            --radius: 8px;
            --text: #333;
            --text-light: #666;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 1rem;
            line-height: 1.6;
            padding-bottom: 60px; /* 为底部导航栏留出空间 */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        h2 {
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        h2 i {
            font-size: 1.4rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-weight: 500;
        }
        input[type="text"],
        input[type="url"],
        input[type="number"],
        input[type="file"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            margin-bottom: 1rem;
            background: #fff;
            transition: border 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
        }
        .cost-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .cost-row input {
            flex: 1;
            min-width: 80px;
        }
        .total-cost-row {
            margin-top: 0.5rem;
        }
        .total-cost-row input {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--text);
        }
        .image-upload {
            margin-top: 0.5rem;
            position: relative;
        }
        .image-upload img {
            width: 100%;
            max-height: 120px;
            object-fit: contain;
            border-radius: var(--radius);
            cursor: zoom-in;
            border: 1px dashed var(--border);
            padding: 5px;
        }
        .actions-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: thin;
        }
        .btn {
            flex: 1 1 auto;
            min-width: 0;
            height: 40px;
            padding: 0.4rem 0.8rem;
            font-size: 0.95rem;
            line-height: 1;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: pointer;
            gap: 8px;
            font-weight: 500;
        }
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        .btn-success {
            background: var(--secondary);
        }
        .btn-success:hover {
            background: #3cb061;
        }
        .btn-info {
            background: var(--info);
        }
        .btn-info:hover {
            background: #5a6dc8;
        }
        .btn-warning {
            background: var(--warning);
            color: #333;
        }
        .btn-warning:hover {
            background: #f5c451;
        }
        .btn-danger {
            background: var(--danger);
        }
        .btn-danger:hover {
            background: #e55c5c;
        }
        .btn-sm {
            height: 32px;
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
        }
        .btn-block {
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            border: 1px solid var(--border);
            text-align: center;
            min-width: 120px;
        }
        th {
            background-color: #f0f5ff;
            font-weight: 600;
            color: var(--primary);
        }
        tr:nth-child(even) {
            background-color: #f8fafd;
        }
        tr:hover {
            background-color: #f0f7ff;
        }
        .table-img {
            max-width: 80px;
            max-height: 80px;
            cursor: zoom-in;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }
        .table-img:hover {
            transform: scale(1.05);
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        /* 自动补全样式 */
        .autocomplete {
            position: relative;
            margin-bottom: 1rem;
        }
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-top: 2px;
            z-index: 100;
            box-shadow: var(--shadow);
            display: none;
        }
        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .autocomplete-item:hover {
            background: #f0f7ff;
        }
        .autocomplete.active .autocomplete-list {
            display: block;
        }
        /* 图片放大模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            background-color: transparent;
            border-radius: 12px;
            overflow: hidden;
        }
        .modal-image {
            width: 100%;
            height: auto;
            max-height: 100%;
            object-fit: contain;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            color: white;
            cursor: pointer;
            z-index: 2;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        .close-modal:hover {
            background: rgba(0,0,0,0.8);
        }
        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
            gap: 0.5rem;
        }
        .page-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .page-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* 弹出选择框 */
        .selection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        .selection-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .selection-header {
            padding: 1rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .selection-body {
            padding: 1rem;
            overflow-y: auto;
            max-height: 60vh;
        }
        .selection-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        .selection-item:last-child {
            border-bottom: none;
        }
        .selection-item:hover {
            background: #f0f7ff;
        }
        /* 通知消息 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--secondary);
            color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background: var(--danger);
        }
        .notification.info {
            background: var(--info);
        }
        /* 加载动画 */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #f0f5ff;
            border-radius: var(--radius);
            font-size: 0.9rem;
            color: var(--text-light);
        }
        /* 折叠内容 */
        .collapsible-content {
            display: none;
            padding-top: 1rem;
        }
        .collapsible-content.active {
            display: block;
        }
        /* 选择按钮 */
        .select-btn {
            width: 40px;
            flex-shrink: 0;
        }
        /* 操作按钮 */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        /* 弹窗样式 */
        .modal-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            margin-bottom: 1rem;
            background: #fff;
        }
        .selection-body .form-group {
            margin-bottom: 1rem;
        }
        #editImagePreview, #orderImagePreview {
            width: 100%;
            object-fit: contain;
            border: 1px dashed var(--border);
            padding: 5px;
        }
        /* 底部导航栏 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            color: #666;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        .nav-item.active {
            color: var(--primary);
            background-color: #f0f7ff;
        }
        .nav-item:hover {
            background-color: #f5f9ff;
        }
        /* 页面容器 */
        .page-container {
            display: none;
        }
        .page-container.active {
            display: block;
        }
        /* 筛选条件选择器 */
        .filter-selector {
            display: flex;
            margin-bottom: 1rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .filter-selector select {
            flex: 1;
            min-width: 150px;
            height: 46px; /* 统一高度 */
        }
        .date-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .date-filter input {
            flex: 1;
        }
        /* 两列布局 */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        /* 三列布局 */
        .three-columns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .two-rows {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        /* 备注文本样式 */
        .notes-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .notes-cell:hover {
            overflow: visible;
            white-space: normal;
            background: white;
            z-index: 100;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* ========== 新增样式 ========== */
        /* 费用行容器 - 横向滚动 */
        .cost-row-container {
            display: flex;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .cost-row-container::-webkit-scrollbar {
            display: none; /* 隐藏滚动条 */
        }
        .cost-row-item {
            flex: 0 0 auto;
            min-width: 100px; /* 从120px改为100px以适应小屏幕 */
            margin-right: 0.5rem;
        }
        .cost-row-item:last-child {
            margin-right: 0;
        }
        .cost-row-item label {
            white-space: nowrap;
        }
        
        /* 行内布局 - 不换行 */
        .inline-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .inline-row > .form-group {
            flex: 1;
            min-width: 150px;
        }
        
        /* 筛选条件高度统一 */
        .filter-selector .autocomplete input {
            height: 46px;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .two-columns, .three-columns, .two-rows {
                grid-template-columns: 1fr;
            }
            
            /* 移动端横向滚动优化 */
            .cost-row-container {
                display: flex;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 0.5rem;
                margin-bottom: 1rem;
            }
            .inline-row {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 0.5rem;
            }
        }
        
        /* 使用须知弹窗样式 */
        #disclaimerModal {
            background-color: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .disclaimer-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .disclaimer-content h2 {
            background: var(--primary);
            color: white;
            padding: 1.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
        }
        
        .disclaimer-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 60vh;
            font-size: 1.05rem;
            line-height: 1.7;
        }
        
        .disclaimer-body ul {
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        
        .disclaimer-body li {
            margin-bottom: 0.8rem;
        }
        
        .disclaimer-footer {
            padding: 1.2rem;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid var(--border);
        }
        
        #closeDisclaimerBtn {
            width: 100%;
            max-width: 250px;
            margin: 0 auto;
            font-size: 1.1rem;
            padding: 0.8rem 1rem;
            background: var(--primary);
            transition: all 0.3s ease;
        }
        
        #closeDisclaimerBtn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        #closeDisclaimerBtn:not(:disabled):hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        /* 汇总行样式 */
        .summary-row {
            background-color: #f0f9ff !important;
            font-weight: bold;
        }
        
        .summary-row td {
            font-weight: 600;
            border-top: 2px solid var(--primary);
        }
        
        .summary-row .profit-positive, 
        .summary-row .profit-negative {
            font-size: 1.05em;
        }
        
        /* 汇总栏样式 - 修改后 */
        .summary-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: var(--radius);
            border: 1px solid #d1e7ff;
            justify-content: center; /* 新增：居中对齐 */
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            flex: 1 1 30%; /* 新增：每行3个，各占30%宽度 */
            max-width: calc(33.33% - 1rem); /* 新增：防止溢出 */
            box-sizing: border-box; /* 新增：包含padding和border在宽度内 */
        }
        
        .summary-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        
        .summary-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .summary-profit {
            color: #28a745;
        }
        
        .summary-loss {
            color: #dc3545;
        }
        
        /* 移动端响应式 */
        @media (max-width: 768px) {
            .summary-item {
                flex: 1 1 30%; /* 小屏幕保持每行3个 */
                min-width: auto; /* 移除固定最小宽度 */
            }
        }
        
        /* 新增：汇总折叠标题样式 */
        .summary-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: var(--radius);
            transition: background 0.2s;
        }
        .summary-header:hover {
            background: #f0f7ff;
        }
        .summary-header i {
            transition: transform 0.3s;
        }
    </style>
</head>
<body>
    <!-- 图片放大模态框 -->
    <div class="modal" id="imageModal">
        <span class="close-modal">&times;</span>
        <div class="modal-content">
            <img class="modal-image" src="" alt="放大图片">
        </div>
    </div>
    <!-- 选择商品模态框 -->
    <div class="selection-modal" id="selectionModal">
        <div class="selection-content">
            <div class="selection-header">
                <h3 id="modalTitle">选择商品</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="selection-body" id="selectionBody"></div>
        </div>
    </div>
    <!-- 编辑商品弹窗 -->
    <div class="selection-modal" id="editProductModal">
        <div class="selection-content" style="max-width: 600px;">
            <div class="selection-header">
                <h3>编辑商品</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="selection-body">
                <div class="form-group autocomplete">
                    <label>商品名称</label>
                    <input type="text" id="editName" class="modal-input">
                    <div class="autocomplete-list" id="editNameAutocomplete"></div>
                </div>
                <div class="form-group autocomplete">
                    <label>SKU/规格</label>
                    <input type="text" id="editSku" class="modal-input">
                    <div class="autocomplete-list" id="editSkuAutocomplete"></div>
                </div>
                <div class="form-group">
                    <label>图片URL</label>
                    <input type="url" id="editImage" class="modal-input" oninput="previewEditImage()">
                    <div class="image-upload">
                        <img id="editImagePreview" src="" style="display: none;">
                    </div>
                </div>
                <div class="form-group">
                    <label>成本、运费及其他费用</label>
                    <div class="cost-row">
                        <input type="number" id="editCost" class="modal-input" oninput="calculateEditTotal()">
                        <input type="number" id="editShipping" class="modal-input" oninput="calculateEditTotal()">
                        <input type="number" id="editOtherCosts" class="modal-input" oninput="calculateEditTotal()">
                    </div>
                    <div class="total-cost-row">
                        <label>总成本</label>
                        <input type="number" id="editTotalCost" readonly class="modal-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea id="editNotes" class="modal-input" rows="2"></textarea>
                </div>
                <button class="btn btn-success btn-block" onclick="saveEditProduct()"><i class="fas fa-sync"></i> 保存修改</button>
                <input type="hidden" id="editProductId">
            </div>
        </div>
    </div>
    <!-- 编辑订单弹窗 -->
    <div class="selection-modal" id="editOrderModal">
        <div class="selection-content" style="max-width: 700px;">
            <div class="selection-header">
                <h3>编辑订单</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="selection-body">
                <div class="two-columns">
                    <div class="form-group autocomplete">
                        <label>平台</label>
                        <input type="text" id="editPlatform" class="modal-input">
                    </div>
                    <div class="form-group autocomplete">
                        <label>店铺名</label>
                        <input type="text" id="editShop" class="modal-input">
                    </div>
                </div>
                <div class="two-columns">
                    <div class="form-group">
                        <label>订单日期</label>
                        <input type="date" id="editOrderDate" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label>订单号</label>
                        <input type="text" id="editOrderNumber" class="modal-input">
                    </div>
                </div>
                <div class="form-group autocomplete">
                    <label>商品名称</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="editOrderName" class="modal-input" oninput="updateOrderSkuOptions(); updateAutocomplete('editOrderName', this.value)">
                        <button class="btn select-btn" onclick="showSelection('orderName')"><i class="fas fa-list"></i></button>
                    </div>
                    <div class="autocomplete-list" id="editOrderNameAutocomplete"></div>
                </div>
                <div class="form-group autocomplete">
                    <label>SKU/规格</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="editOrderSku" class="modal-input" oninput="populateOrderCost(); updateAutocomplete('editOrderSku', this.value)">
                        <button class="btn select-btn" onclick="showSelection('orderSku')"><i class="fas fa-list"></i></button>
                    </div>
                    <div class="autocomplete-list" id="editOrderSkuAutocomplete"></div>
                </div>
                <div class="form-group">
                    <label>图片URL</label>
                    <input type="url" id="editOrderImage" class="modal-input" oninput="previewOrderEditImage()">
                    <div class="image-upload">
                        <img id="editOrderImagePreview" src="" style="display: none;">
                    </div>
                </div>
                <div class="two-rows">
                    <div class="form-group">
                        <label>实付款</label>
                        <input type="number" id="editAmountPaid" class="modal-input" oninput="calculateOrderProfit()">
                    </div>
                    <div class="form-group">
                        <label>成本</label>
                        <input type="number" id="editOrderCost" class="modal-input" oninput="calculateOrderTotalCost()">
                    </div>
                </div>
                <!-- 修改后的运费、打包费、其他费用行 - 使用与商品录入相同的布局 -->
                <div class="form-group">
                    <label>运费、打包费及其他费用</label>
                    <div class="cost-row">
                        <input type="number" id="editOrderShipping" class="modal-input" placeholder="运费" oninput="calculateOrderTotalCost()">
                        <input type="number" id="editPackingFee" class="modal-input" placeholder="打包费" oninput="calculateOrderTotalCost()">
                        <input type="number" id="editOrderOtherCosts" class="modal-input" placeholder="其他费用" oninput="calculateOrderTotalCost()">
                    </div>
                </div>
                <!-- 修改后的总成本和利润行 -->
                <div class="inline-row">
                    <div class="form-group">
                        <label>订单总成本</label>
                        <input type="number" id="editOrderTotalCost" readonly class="modal-input">
                    </div>
                    <div class="form-group">
                        <label>利润</label>
                        <input type="number" id="editProfit" readonly class="modal-input">
                    </div>
                </div>
                <!-- 修改后的快递信息行 -->
                <div class="inline-row">
                    <div class="form-group">
                        <label>快递公司</label>
                        <input type="text" id="editCourier" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label>快递单号</label>
                        <input type="text" id="editTrackingNumber" class="modal-input">
                    </div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea id="editOrderNotes" class="modal-input" rows="2"></textarea>
                </div>
                <button class="btn btn-success btn-block" onclick="saveEditOrder()"><i class="fas fa-sync"></i> 保存修改</button>
                <input type="hidden" id="editOrderId">
            </div>
        </div>
    </div>
    <!-- 通知消息 -->
    <div class="notification" id="notification">操作成功！</div>
    
    <!-- 商品管理页面 -->
    <div class="container page-container" id="productPage"> <!-- 移除active类 -->
        <!-- 录入区域 -->
        <div class="card">
            <h2 onclick="toggleCollapse(this)"><i class="fas fa-plus-circle"></i>商品信息录入 <i class="fas fa-chevron-down"></i></h2>
            <div class="collapsible-content active" id="entrySection">
                <div class="form-group autocomplete">
                    <label>商品名称</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="productName" placeholder="输入商品名称" oninput="updateAutocomplete('name', this.value)">
                        <button class="btn select-btn" onclick="showSelection('name')"><i class="fas fa-list"></i></button>
                    </div>
                    <div class="autocomplete-list" id="nameAutocomplete"></div>
                </div>
                <div class="form-group autocomplete">
                    <label>SKU/规格</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="productSku" placeholder="输入SKU/规格" oninput="updateAutocomplete('sku', this.value)">
                        <button class="btn select-btn" onclick="showSelection('sku')"><i class="fas fa-list"></i></button>
                    </div>
                    <div class="autocomplete-list" id="skuAutocomplete"></div>
                </div>
                <div class="form-group">
                    <label>图片URL</label>
                    <input type="url" id="productImage" placeholder="输入图片地址">
                    <div class="image-upload">
                        <img id="imagePreview" src="" style="display: none;">
                    </div>
                </div>
                <div class="form-group">
                    <label>成本、运费及其他费用</label>
                    <div class="cost-row">
                        <input type="number" id="cost" placeholder="成本" oninput="calculateTotal()">
                        <input type="number" id="shipping" placeholder="运费" oninput="calculateTotal()">
                        <input type="number" id="otherCosts" placeholder="其他费用" oninput="calculateTotal()">
                    </div>
                    <div class="total-cost-row">
                        <label>总成本</label>
                        <input type="number" id="totalCost" readonly placeholder="自动计算">
                    </div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea id="productNotes" placeholder="商品备注信息" rows="2"></textarea>
                </div>
                <button class="btn btn-success btn-block" id="submitProductBtn"><i class="fas fa-check"></i> 提交</button>
                <input type="hidden" id="editProductId" value="">
            </div>
        </div>
        <!-- 批量导入 -->
        <div class="card">
            <h2 onclick="toggleCollapse(this)"><i class="fas fa-file-import"></i>批量导入 <i class="fas fa-chevron-down"></i></h2>
            <div class="collapsible-content" id="importSection">
                <button class="btn btn-info btn-block" id="importProductBtn"><i class="fas fa-file-import"></i> 选择Excel文件导入</button>
                <input type="file" id="productFileInput" accept=".xlsx,.xls" style="display: none;">
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <p>导入说明：</p>
                    <ul style="padding-left: 20px; margin-top: 5px;">
                        <li>Excel文件必须包含以下列：商品名称, SKU, 图片URL, 成本, 运费, 其他费用, 备注</li>
                        <li>第一行应为列标题</li>
                        <li>支持 .xlsx 和 .xls 格式</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- 筛选与操作 -->
        <div class="card">
            <h2 onclick="toggleCollapse(this)"><i class="fas fa-filter"></i>商品筛选 <i class="fas fa-chevron-down"></i></h2>
            <div class="collapsible-content" id="filterSection">
                <div class="form-group autocomplete">
                    <label>筛选条件</label>
                    <input type="text" id="searchInput" placeholder="输入商品名称或SKU" oninput="updateAutocomplete('search', this.value)">
                    <div class="autocomplete-list" id="searchAutocomplete"></div>
                </div>
                <div class="actions-bar">
                    <button class="btn" onclick="filterProducts()"><i class="fas fa-search"></i> 筛选</button>
                    <button class="btn" onclick="showAllData()"><i class="fas fa-list"></i> 全部</button>
                    <button class="btn btn-success" onclick="exportAllProducts()"><i class="fas fa-file-export"></i> 导出全部</button>
                    <button class="btn btn-warning" onclick="exportFilteredProducts()"><i class="fas fa-file-download"></i> 导出筛选</button>
                </div>
            </div>
        </div>
        <!-- 商品列表 -->
        <div class="card">
            <h2><i class="fas fa-boxes"></i>商品列表</h2>
            <div style="overflow-x:auto">
                <table id="productTable">
                    <thead>
                        <tr>
                            <th>商品名称</th>
                            <th>SKU</th>
                            <th>图片</th>
                            <th>成本</th>
                            <th>运费</th>
                            <th>其他费用</th>
                            <th>总成本</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- 分页控件 -->
            <div class="pagination" id="productPagination"></div>
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="productItemCount">共加载 0 条记录</div>
                <div id="productStorageStatus">本地存储: 已启用</div>
            </div>
        </div>
    </div>
    
    <!-- 订单管理页面 -->
    <div class="container page-container active" id="orderPage"> <!-- 添加active类 -->
        <!-- 订单录入区域 -->
        <div class="card">
            <h2 onclick="toggleCollapse(this)"><i class="fas fa-plus-circle"></i>订单信息录入 <i class="fas fa-chevron-down"></i></h2>
            <div class="collapsible-content active" id="orderEntrySection">
                <div class="two-columns">
                    <div class="form-group autocomplete">
                        <label>平台</label>
                        <input type="text" id="orderPlatform" placeholder="淘宝、京东、拼多多等">
                    </div>
                    <div class="form-group autocomplete">
                        <label>店铺名</label>
                        <input type="text" id="orderShop" placeholder="输入店铺名称">
                    </div>
                </div>
                <div class="two-columns">
                    <div class="form-group">
                        <label>订单日期</label>
                        <input type="date" id="orderDate">
                    </div>
                    <div class="form-group">
                        <label>订单号</label>
                        <input type="text" id="orderNumber" placeholder="输入订单号">
                    </div>
                </div>
                <!-- 修改点：为商品名称添加自动补全功能 -->
                <div class="form-group autocomplete">
                    <label>商品名称</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="orderProductName" placeholder="输入商品名称" oninput="updateSkuOptions(); updateAutocomplete('orderName', this.value)">
                        <button class="btn select-btn" onclick="showSelection('orderName')"><i class="fas fa-list"></i></button>
                    </div>
                    <!-- 新增自动补全列表 -->
                    <div class="autocomplete-list" id="orderNameAutocomplete"></div>
                </div>
                
                <!-- 修改点：为SKU/规格添加自动补全功能 -->
                <div class="form-group autocomplete">
                    <label>SKU/规格</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="orderSku" placeholder="输入SKU/规格" oninput="populateCost(); updateAutocomplete('orderSku', this.value)">
                        <button class="btn select-btn" onclick="showSelection('orderSku')"><i class="fas fa-list"></i></button>
                    </div>
                    <!-- 新增自动补全列表 -->
                    <div class="autocomplete-list" id="orderSkuAutocomplete"></div>
                </div>
                <div class="form-group">
                    <label>图片URL</label>
                    <input type="url" id="orderImage" placeholder="输入图片地址">
                    <div class="image-upload">
                        <img id="orderImagePreview" src="" style="display: none;">
                    </div>
                </div>
                <div class="two-rows">
                    <div class="form-group">
                        <label>实付款</label>
                        <input type="number" id="amountPaid" placeholder="实际支付金额" oninput="calculateProfit()">
                    </div>
                    <div class="form-group">
                        <label>成本</label>
                        <input type="number" id="orderCost" placeholder="商品成本" oninput="calculateTotalCost()">
                    </div>
                </div>
                <!-- 修改后的运费、打包费、其他费用行 - 使用与商品录入相同的布局 -->
                <div class="form-group">
                    <label>运费、打包费及其他费用</label>
                    <div class="cost-row">
                        <input type="number" id="orderShipping" placeholder="运费" oninput="calculateTotalCost()">
                        <input type="number" id="packingFee" placeholder="打包费" oninput="calculateTotalCost()">
                        <input type="number" id="orderOtherCosts" placeholder="其他费用" oninput="calculateTotalCost()">
                    </div>
                </div>
                <!-- 修改后的总成本和利润行 -->
                <div class="inline-row">
                    <div class="form-group">
                        <label>订单总成本</label>
                        <input type="number" id="orderTotalCost" readonly placeholder="自动计算">
                    </div>
                    <div class="form-group">
                        <label>利润</label>
                        <input type="number" id="profit" readonly placeholder="自动计算">
                    </div>
                </div>
                <!-- 修改后的快递信息行 -->
                <div class="inline-row">
                    <div class="form-group">
                        <label>快递公司</label>
                        <input type="text" id="courier" placeholder="输入快递公司">
                    </div>
                    <div class="form-group">
                        <label>快递单号</label>
                        <input type="text" id="trackingNumber" placeholder="输入快递单号">
                    </div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea id="orderNotes" placeholder="订单备注信息" rows="2"></textarea>
                </div>
                <button class="btn btn-success btn-block" id="submitOrderBtn"><i class="fas fa-check"></i> 提交订单</button>
                <input type="hidden" id="editOrderId" value="">
            </div>
        </div>
        <!-- 订单批量导入 -->
        <div class="card">
            <h2 onclick="toggleCollapse(this)"><i class="fas fa-file-import"></i>订单批量导入 <i class="fas fa-chevron-down"></i></h2>
            <div class="collapsible-content" id="orderImportSection">
                <button class="btn btn-info btn-block" id="importOrderBtn"><i class="fas fa-file-import"></i> 选择Excel文件导入</button>
                <input type="file" id="orderFileInput" accept=".xlsx,.xls" style="display: none;">
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <p>导入说明：</p>
                    <ul style="padding-left: 20px; margin-top: 5px;">
                        <li>Excel文件必须包含以下列：平台, 店铺名, 订单日期, 订单号, 商品名称, SKU, 图片URL, 实付款, 成本, 运费, 打包费, 其他费用, 快递公司, 快递单号, 备注</li>
                        <li>第一行应为列标题</li>
                        <li>支持 .xlsx 和 .xls 格式</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- 订单筛选 -->
        <div class="card">
            <h2 onclick="toggleCollapse(this)"><i class="fas fa-filter"></i>订单筛选 <i class="fas fa-chevron-down"></i></h2>
            <div class="collapsible-content" id="orderFilterSection">
                <div class="filter-selector">
                    <select id="filterType">
                        <option value="shop">店铺名</option>
                        <option value="orderNumber">订单号</option>
                        <option value="productName">商品名称</option>
                        <option value="sku">SKU/规格</option>
                        <option value="trackingNumber">快递单号</option>
                    </select>
                    <div class="autocomplete" style="flex: 3;">
                        <input type="text" id="orderSearchInput" placeholder="输入筛选内容" oninput="updateAutocomplete('orderSearch', this.value)">
                        <div class="autocomplete-list" id="orderSearchAutocomplete"></div>
                    </div>
                </div>
                <div class="date-filter">
                    <input type="date" id="startDate" placeholder="开始日期">
                    <input type="date" id="endDate" placeholder="结束日期">
                </div>
                <div class="actions-bar">
                    <button class="btn" onclick="filterOrders()"><i class="fas fa-search"></i> 筛选</button>
                    <button class="btn" onclick="showAllOrders()"><i class="fas fa-list"></i> 全部</button>
                    <button class="btn btn-success" onclick="exportAllOrders()"><i class="fas fa-file-export"></i> 导出全部</button>
                    <button class="btn btn-warning" onclick="exportFilteredOrders()"><i class="fas fa-file-download"></i> 导出筛选</button>
                </div>
            </div>
        </div>
        <!-- 订单列表 -->
        <div class="card">
            <h2><i class="fas fa-receipt"></i>订单列表</h2>
            
            <!-- 修改：将汇总栏放入可折叠区域 -->
            <div class="summary-header" onclick="toggleCollapse(this)">
                <i class="fas fa-calculator"></i>
                <span>订单汇总</span>
                <i class="fas fa-chevron-right"></i>
            </div>
            <div class="collapsible-content" id="orderSummarySection">
                <div class="summary-bar" id="orderSummaryBar">
                    <div class="summary-item">
                        <div class="summary-label">实付款</div>
                        <div class="summary-value" id="summaryAmountPaid">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">成本</div>
                        <div class="summary-value" id="summaryCost">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">运费</div>
                        <div class="summary-value" id="summaryShipping">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">打包费</div>
                        <div class="summary-value" id="summaryPackingFee">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">其他费用</div>
                        <div class="summary-value" id="summaryOtherCosts">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">总成本</div>
                        <div class="summary-value" id="summaryTotalCost">0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">利润</div>
                        <div class="summary-value" id="summaryProfit">0.00</div>
                    </div>
                </div>
            </div>
            
            <div style="overflow-x:auto">
                <table id="orderTable">
                    <thead>
                        <tr>
                            <th>平台</th>
                            <th>店铺名</th>
                            <th>订单日期</th>
                            <th>订单号</th>
                            <th>商品名称</th>
                            <th>SKU</th>
                            <th>图片</th>
                            <th>实付款</th>
                            <th>成本</th>
                            <th>运费</th>
                            <th>打包费</th>
                            <th>其他费用</th>
                            <th>总成本</th>
                            <th>利润</th>
                            <th>快递公司</th>
                            <th>快递单号</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- 分页控件 -->
            <div class="pagination" id="orderPagination"></div>
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="orderItemCount">共加载 0 条记录</div>
                <div id="orderStorageStatus">本地存储: 已启用</div>
            </div>
        </div>
    </div>
    
    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="nav-item" data-page="productPage"> <!-- 移除active类 -->
            <i class="fas fa-box"></i>
            <span>商品</span>
        </div>
        <div class="nav-item active" data-page="orderPage"> <!-- 添加active类 -->
            <i class="fas fa-receipt"></i>
            <span>订单</span>
        </div>
        <div class="nav-item" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
            <span>刷新</span>
        </div>
    </div>

    <!-- SheetJS库 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // 全局变量
        let products = [];
        let orders = [];
        let filteredProducts = [];
        let filteredOrders = [];
        let currentProductPage = 1;
        let currentOrderPage = 1;
        const itemsPerPage = 10;
        const productStorageKey = 'productManagementSystemData';
        const orderStorageKey = 'orderManagementSystemData';
        
        // DOM 加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupNavigation();
        });
        
        // 初始化应用
        function initApp() {
            loadProductsFromLocalStorage();
            loadOrdersFromLocalStorage();
            setupEventListeners();
            updateAutocompleteLists();
            renderProductTable();
            renderOrderTable();
        }
        
        // 设置导航栏
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.id !== 'refreshBtn') {
                    item.addEventListener('click', function() {
                        // 移除所有active类
                        navItems.forEach(nav => nav.classList.remove('active'));
                        // 添加active类到当前项
                        this.classList.add('active');
                        // 隐藏所有页面
                        document.querySelectorAll('.page-container').forEach(page => {
                            page.classList.remove('active');
                        });
                        // 显示当前页面
                        const pageId = this.getAttribute('data-page');
                        document.getElementById(pageId).classList.add('active');
                    });
                }
            });
            
            // 刷新按钮
            document.getElementById('refreshBtn').addEventListener('click', function() {
                showNotification('系统已刷新', false, true);
                setTimeout(() => {
                    location.reload();
                }, 1000);
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 商品部分
            document.querySelectorAll('#cost, #shipping, #otherCosts').forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
            document.getElementById('productImage').addEventListener('input', function() {
                const img = document.getElementById('imagePreview');
                img.src = this.value && this.value.startsWith('http') ? this.value : '';
                img.style.display = this.value ? 'block' : 'none';
            });
            document.getElementById('submitProductBtn').addEventListener('click', submitProduct);
            
            // 商品导入按钮 - 修复后
            document.getElementById('importProductBtn').addEventListener('click', function() {
                document.getElementById('productFileInput').click();
            });
            document.getElementById('productFileInput').addEventListener('change', function(e) {
                handleExcelImport(e.target.files[0]);
            });
            
            // 订单部分
            document.getElementById('orderProductName').addEventListener('input', updateSkuOptions);
            document.getElementById('orderSku').addEventListener('input', populateCost);
            document.querySelectorAll('#amountPaid, #orderCost, #orderShipping, #packingFee, #orderOtherCosts').forEach(input => {
                input.addEventListener('input', calculateTotalCost);
            });
            document.getElementById('submitOrderBtn').addEventListener('click', submitOrder);
            document.getElementById('orderImage').addEventListener('input', function() {
                const img = document.getElementById('orderImagePreview');
                img.src = this.value && this.value.startsWith('http') ? this.value : '';
                img.style.display = this.value ? 'block' : 'none';
            });
            
            // 订单导入按钮 - 修复后
            document.getElementById('importOrderBtn').addEventListener('click', function() {
                document.getElementById('orderFileInput').click();
            });
            document.getElementById('orderFileInput').addEventListener('change', function(e) {
                handleOrderExcelImport(e.target.files[0]);
            });
            
            // 通用
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG' && e.target.src) {
                    openImageModal(e.target.src);
                }
            });
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('imageModal').style.display = 'none';
                    document.getElementById('selectionModal').style.display = 'none';
                    document.getElementById('editProductModal').style.display = 'none';
                    document.getElementById('editOrderModal').style.display = 'none';
                });
            });
            document.getElementById('productName').addEventListener('input', function() {
                updateAutocomplete('name', this.value);
            });
            document.getElementById('productSku').addEventListener('input', function() {
                updateAutocomplete('sku', this.value);
            });
            document.getElementById('searchInput').addEventListener('input', function() {
                updateAutocomplete('search', this.value);
            });
            document.getElementById('orderSearchInput').addEventListener('input', function() {
                updateAutocomplete('orderSearch', this.value);
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('imageModal').style.display = 'none';
                    document.getElementById('selectionModal').style.display = 'none';
                    document.getElementById('editProductModal').style.display = 'none';
                    document.getElementById('editOrderModal').style.display = 'none';
                }
            });
        }
        
        // 加载商品数据
        function loadProductsFromLocalStorage() {
            const storedData = localStorage.getItem(productStorageKey);
            if (storedData) {
                try {
                    products = JSON.parse(storedData);
                } catch (e) {
                    console.error('解析商品数据失败:', e);
                    products = [];
                }
            }
            document.getElementById('productStorageStatus').textContent = `本地存储: ${products.length} 条记录`;
        }
        
        // 加载订单数据
        function loadOrdersFromLocalStorage() {
            const storedData = localStorage.getItem(orderStorageKey);
            if (storedData) {
                try {
                    orders = JSON.parse(storedData);
                } catch (e) {
                    console.error('解析订单数据失败:', e);
                    orders = [];
                }
            }
            document.getElementById('orderStorageStatus').textContent = `本地存储: ${orders.length} 条记录`;
        }
        
        // 保存商品数据
        function saveProductsToLocalStorage() {
            localStorage.setItem(productStorageKey, JSON.stringify(products));
            document.getElementById('productStorageStatus').textContent = `本地存储: ${products.length} 条记录`;
        }
        
        // 保存订单数据
        function saveOrdersToLocalStorage() {
            localStorage.setItem(orderStorageKey, JSON.stringify(orders));
            document.getElementById('orderStorageStatus').textContent = `本地存储: ${orders.length} 条记录`;
        }
        
        // ========== 商品管理功能 ==========
        // 计算总成本
        function calculateTotal() {
            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const shipping = parseFloat(document.getElementById('shipping').value) || 0;
            const otherCosts = parseFloat(document.getElementById('otherCosts').value) || 0;
            document.getElementById('totalCost').value = (cost + shipping + otherCosts).toFixed(2);
        }
        
        // 提交商品
        function submitProduct() {
            const product = {
                id: document.getElementById('editProductId').value || Date.now(),
                name: document.getElementById('productName').value.trim(),
                sku: document.getElementById('productSku').value.trim(),
                image: document.getElementById('productImage').value.trim(),
                cost: parseFloat(document.getElementById('cost').value) || 0,
                shipping: parseFloat(document.getElementById('shipping').value) || 0,
                otherCosts: parseFloat(document.getElementById('otherCosts').value) || 0,
                total: parseFloat(document.getElementById('totalCost').value) || 0,
                notes: document.getElementById('productNotes').value.trim(),
                createdAt: new Date().toISOString()
            };
            if (!product.name || !product.sku) {
                showNotification('请填写商品名称和SKU！', true);
                return;
            }
            let existing;
            if (document.getElementById('editProductId').value) {
                existing = products.find(p => p.id == product.id);
            } else {
                existing = products.find(p => p.name === product.name && p.sku === product.sku);
            }
            if (existing) {
                if (!document.getElementById('editProductId').value && !confirm('已存在相同名称和SKU的商品，是否更新？')) return;
                Object.assign(existing, product);
                showNotification('商品更新成功！');
            } else {
                products.unshift(product);
                showNotification('商品添加成功！');
            }
            updateAutocompleteLists();
            saveProductsToLocalStorage();
            renderProductTable();
            clearProductForm();
        }
        
        // 清除商品表单
        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productSku').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('cost').value = '';
            document.getElementById('shipping').value = '';
            document.getElementById('otherCosts').value = '';
            document.getElementById('totalCost').value = '';
            document.getElementById('productNotes').value = '';
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('editProductId').value = '';
            document.getElementById('submitProductBtn').innerHTML = '<i class="fas fa-check"></i> 提交';
        }
        
        // 编辑商品
        function editProduct(id) {
            const product = products.find(p => p.id == id);
            if (!product) return;
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editName').value = product.name;
            document.getElementById('editSku').value = product.sku;
            document.getElementById('editImage').value = product.image;
            document.getElementById('editCost').value = product.cost;
            document.getElementById('editShipping').value = product.shipping;
            document.getElementById('editOtherCosts').value = product.otherCosts;
            document.getElementById('editTotalCost').value = product.total;
            document.getElementById('editNotes').value = product.notes || '';
            const img = document.getElementById('editImagePreview');
            img.src = product.image && product.image.startsWith('http') ? product.image : '';
            img.style.display = product.image ? 'block' : 'none';
            document.getElementById('editProductModal').style.display = 'flex';
        }
        
        function previewEditImage() {
            const img = document.getElementById('editImagePreview');
            const url = document.getElementById('editImage').value;
            img.src = url && url.startsWith('http') ? url : '';
            img.style.display = url ? 'block' : 'none';
        }
        
        function calculateEditTotal() {
            const cost = parseFloat(document.getElementById('editCost').value) || 0;
            const shipping = parseFloat(document.getElementById('editShipping').value) || 0;
            const otherCosts = parseFloat(document.getElementById('editOtherCosts').value) || 0;
            document.getElementById('editTotalCost').value = (cost + shipping + otherCosts).toFixed(2);
        }
        
        function saveEditProduct() {
            const id = document.getElementById('editProductId').value;
            const product = products.find(p => p.id == id);
            if (!product) return;
            const name = document.getElementById('editName').value.trim();
            const sku = document.getElementById('editSku').value.trim();
            if (!name || !sku) {
                showNotification('请填写商品名称和SKU！', true);
                return;
            }
            product.name = name;
            product.sku = sku;
            product.image = document.getElementById('editImage').value.trim();
            product.cost = parseFloat(document.getElementById('editCost').value) || 0;
            product.shipping = parseFloat(document.getElementById('editShipping').value) || 0;
            product.otherCosts = parseFloat(document.getElementById('editOtherCosts').value) || 0;
            product.total = parseFloat(document.getElementById('editTotalCost').value) || 0;
            product.notes = document.getElementById('editNotes').value.trim();
            saveProductsToLocalStorage();
            renderProductTable();
            document.getElementById('editProductModal').style.display = 'none';
            showNotification('商品更新成功！');
        }
        
        // 删除商品
        function deleteProduct(id) {
            if (!confirm('确定要删除这个商品吗？此操作不可恢复。')) return;
            const index = products.findIndex(p => p.id == id);
            if (index !== -1) {
                products.splice(index, 1);
                saveProductsToLocalStorage();
                renderProductTable();
                showNotification('商品已删除！');
            }
        }
        
        // 渲染商品表格
        function renderProductTable(data = products) {
            filteredProducts = [...data];
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            const startIndex = (currentProductPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);
            if (pageProducts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem;">没有找到商品数据</td></tr>`;
            } else {
                pageProducts.forEach(product => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.sku}</td>
                        <td>
                            ${product.image ? 
                                `<img src="${product.image}" class="table-img" alt="${product.name}">` : 
                                '<span style="color:#999">无图片</span>'}
                        </td>
                        <td>${product.cost.toFixed(2)}</td>
                        <td>${product.shipping.toFixed(2)}</td>
                        <td>${product.otherCosts.toFixed(2)}</td>
                        <td><strong>${product.total.toFixed(2)}</strong></td>
                        <td class="notes-cell">${product.notes || ''}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            renderProductPagination();
            document.getElementById('productItemCount').textContent = `显示 ${pageProducts.length} 条，共 ${filteredProducts.length} 条记录`;
        }
        
        // 渲染商品分页
        function renderProductPagination() {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const paginationEl = document.getElementById('productPagination');
            paginationEl.innerHTML = '';
            if (totalPages <= 1) return;
            const prevBtn = document.createElement('div');
            prevBtn.className = `page-btn ${currentProductPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.onclick = () => {
                if (currentProductPage > 1) {
                    currentProductPage--;
                    renderProductTable();
                }
            };
            paginationEl.appendChild(prevBtn);
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = `page-btn ${i === currentProductPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentProductPage = i;
                    renderProductTable();
                };
                paginationEl.appendChild(pageBtn);
            }
            const nextBtn = document.createElement('div');
            nextBtn.className = `page-btn ${currentProductPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.onclick = () => {
                if (currentProductPage < totalPages) {
                    currentProductPage++;
                    renderProductTable();
                }
            };
            paginationEl.appendChild(nextBtn);
        }
        
        // 文件导入
        function handleExcelImport(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    const requiredFields = ['商品名称', 'SKU', '图片URL', '成本', '运费', '其他费用'];
                    const headers = Object.keys(json[0] || {});
                    const missingFields = requiredFields.filter(field => !headers.includes(field));
                    if (missingFields.length > 0) {
                        showNotification(`缺少必要字段: ${missingFields.join(', ')}`, true);
                        return;
                    }
                    const imported = json.map(item => ({
                        id: Date.now() + Math.random(),
                        name: item['商品名称'] || '',
                        sku: item['SKU'] || '',
                        image: item['图片URL'] || '',
                        cost: parseFloat(item['成本']) || 0,
                        shipping: parseFloat(item['运费']) || 0,
                        otherCosts: parseFloat(item['其他费用']) || 0,
                        total: (parseFloat(item['成本']) + parseFloat(item['运费']) + parseFloat(item['其他费用'])) || 0,
                        notes: item['备注'] || '',
                        createdAt: new Date().toISOString()
                    }));
                    products = [...products, ...imported];
                    updateAutocompleteLists();
                    saveProductsToLocalStorage();
                    renderProductTable();
                    showNotification(`成功导入 ${imported.length} 条商品数据！`);
                } catch (error) {
                    console.error('导入错误:', error);
                    showNotification('导入失败，请检查文件格式和内容', true);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 筛选商品
        function filterProducts() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!keyword) {
                renderProductTable();
                return;
            }
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(keyword) ||
                p.sku.toLowerCase().includes(keyword)
            );
            currentProductPage = 1;
            renderProductTable(filtered);
            showNotification(`找到 ${filtered.length} 条匹配记录`);
        }
        
        // 查看全部商品
        function showAllData() {
            document.getElementById('searchInput').value = '';
            currentProductPage = 1;
            renderProductTable();
            showNotification('显示全部商品数据');
        }
        
        // 导出商品到Excel
        function exportToExcel(data, filename) {
            if (data.length === 0) {
                showNotification('没有数据可导出', true);
                return;
            }
            try {
                const ws = XLSX.utils.json_to_sheet(data.map(p => ({
                    '商品名称': p.name,
                    'SKU': p.sku,
                    '图片URL': p.image,
                    '成本': p.cost,
                    '运费': p.shipping,
                    '其他费用': p.otherCosts,
                    '总成本': p.total,
                    '备注': p.notes || '',
                    '创建时间': new Date(p.createdAt).toLocaleString()
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '商品列表');
                const now = new Date();
                const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
                const timeStr = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
                const fileName = `${filename}_${dateStr}_${timeStr}.xlsx`;
                
                // 使用5+ API保存文件
                saveFileWith5Plus(wb, fileName);
            } catch (e) {
                console.error('导出错误:', e);
                showNotification('导出失败: ' + e.message, true);
            }
        }
        
        function exportAllProducts() { 
            exportToExcel(products, '全部商品数据');
        }
        
        function exportFilteredProducts() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            const data = keyword ? 
                products.filter(p => 
                    p.name.toLowerCase().includes(keyword) || 
                    p.sku.toLowerCase().includes(keyword)
                ) : 
                products;
            exportToExcel(data, keyword ? '筛选商品数据' : '全部商品数据');
        }
        
        // ========== 订单管理功能 ==========
        // 更新SKU选项
        function updateSkuOptions() {
            const name = document.getElementById('orderProductName').value.trim().toLowerCase();
            const skuInput = document.getElementById('orderSku');
            if (!name) {
                skuInput.value = '';
                return;
            }
            const product = products.find(p => p.name.toLowerCase() === name);
            if (product) {
                skuInput.value = product.sku;
                populateCost();
            }
        }
        
        // 填充成本数据
        function populateCost() {
            const name = document.getElementById('orderProductName').value.trim().toLowerCase();
            const sku = document.getElementById('orderSku').value.trim().toLowerCase();
            if (!name || !sku) return;
            const product = products.find(p => 
                p.name.toLowerCase() === name && 
                p.sku.toLowerCase() === sku
            );
            if (product) {
                document.getElementById('orderCost').value = product.total;
                document.getElementById('orderImage').value = product.image;
                const img = document.getElementById('orderImagePreview');
                img.src = product.image && product.image.startsWith('http') ? product.image : '';
                img.style.display = product.image ? 'block' : 'none';
                calculateTotalCost();
            }
        }
        
        // 计算订单总成本和利润
        function calculateTotalCost() {
            const cost = parseFloat(document.getElementById('orderCost').value) || 0;
            const shipping = parseFloat(document.getElementById('orderShipping').value) || 0;
            const packingFee = parseFloat(document.getElementById('packingFee').value) || 0;
            const otherCosts = parseFloat(document.getElementById('orderOtherCosts').value) || 0;
            const totalCost = cost + shipping + packingFee + otherCosts;
            document.getElementById('orderTotalCost').value = totalCost.toFixed(2);
            calculateProfit();
        }
        
        function calculateProfit() {
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const totalCost = parseFloat(document.getElementById('orderTotalCost').value) || 0;
            const profit = amountPaid - totalCost;
            document.getElementById('profit').value = profit.toFixed(2);
        }
        
        // 提交订单
        function submitOrder() {
            const order = {
                id: document.getElementById('editOrderId').value || Date.now(),
                platform: document.getElementById('orderPlatform').value.trim(),
                shop: document.getElementById('orderShop').value.trim(),
                orderDate: document.getElementById('orderDate').value || new Date().toISOString().split('T')[0],
                orderNumber: document.getElementById('orderNumber').value.trim(),
                productName: document.getElementById('orderProductName').value.trim(),
                sku: document.getElementById('orderSku').value.trim(),
                image: document.getElementById('orderImage').value.trim(),
                amountPaid: parseFloat(document.getElementById('amountPaid').value) || 0,
                cost: parseFloat(document.getElementById('orderCost').value) || 0,
                shipping: parseFloat(document.getElementById('orderShipping').value) || 0,
                packingFee: parseFloat(document.getElementById('packingFee').value) || 0,
                otherCosts: parseFloat(document.getElementById('orderOtherCosts').value) || 0,
                totalCost: parseFloat(document.getElementById('orderTotalCost').value) || 0,
                profit: parseFloat(document.getElementById('profit').value) || 0,
                courier: document.getElementById('courier').value.trim(),
                trackingNumber: document.getElementById('trackingNumber').value.trim(),
                notes: document.getElementById('orderNotes').value.trim(),
                createdAt: new Date().toISOString()
            };
            if (!order.platform || !order.shop || !order.orderNumber || !order.productName || !order.sku) {
                showNotification('请填写必填字段！', true);
                return;
            }
            let existing;
            if (document.getElementById('editOrderId').value) {
                existing = orders.find(o => o.id == order.id);
            } else {
                existing = orders.find(o => o.orderNumber === order.orderNumber);
            }
            if (existing) {
                if (!document.getElementById('editOrderId').value && !confirm('已存在相同订单号的订单，是否更新？')) return;
                Object.assign(existing, order);
                showNotification('订单更新成功！');
            } else {
                orders.unshift(order);
                showNotification('订单添加成功！');
            }
            saveOrdersToLocalStorage();
            renderOrderTable();
            clearOrderForm();
        }
        
        // 清除订单表单
        function clearOrderForm() {
            document.getElementById('orderPlatform').value = '';
            document.getElementById('orderShop').value = '';
            document.getElementById('orderDate').value = '';
            document.getElementById('orderNumber').value = '';
            document.getElementById('orderProductName').value = '';
            document.getElementById('orderSku').value = '';
            document.getElementById('orderImage').value = '';
            document.getElementById('amountPaid').value = '';
            document.getElementById('orderCost').value = '';
            document.getElementById('orderShipping').value = '';
            document.getElementById('packingFee').value = '';
            document.getElementById('orderOtherCosts').value = '';
            document.getElementById('orderTotalCost').value = '';
            document.getElementById('profit').value = '';
            document.getElementById('courier').value = '';
            document.getElementById('trackingNumber').value = '';
            document.getElementById('orderNotes').value = '';
            document.getElementById('orderImagePreview').src = '';
            document.getElementById('orderImagePreview').style.display = 'none';
            document.getElementById('editOrderId').value = '';
            document.getElementById('submitOrderBtn').innerHTML = '<i class="fas fa-check"></i> 提交订单';
        }
        
        // 编辑订单
        function editOrder(id) {
            const order = orders.find(o => o.id == id);
            if (!order) return;
            document.getElementById('editOrderId').value = order.id;
            document.getElementById('editPlatform').value = order.platform;
            document.getElementById('editShop').value = order.shop;
            document.getElementById('editOrderDate').value = order.orderDate;
            document.getElementById('editOrderNumber').value = order.orderNumber;
            document.getElementById('editOrderName').value = order.productName;
            document.getElementById('editOrderSku').value = order.sku;
            document.getElementById('editOrderImage').value = order.image;
            document.getElementById('editAmountPaid').value = order.amountPaid;
            document.getElementById('editOrderCost').value = order.cost;
            document.getElementById('editOrderShipping').value = order.shipping;
            document.getElementById('editPackingFee').value = order.packingFee;
            document.getElementById('editOrderOtherCosts').value = order.otherCosts;
            document.getElementById('editOrderTotalCost').value = order.totalCost;
            document.getElementById('editProfit').value = order.profit;
            document.getElementById('editCourier').value = order.courier;
            document.getElementById('editTrackingNumber').value = order.trackingNumber;
            document.getElementById('editOrderNotes').value = order.notes;
            const img = document.getElementById('editOrderImagePreview');
            img.src = order.image && order.image.startsWith('http') ? order.image : '';
            img.style.display = order.image ? 'block' : 'none';
            document.getElementById('editOrderModal').style.display = 'flex';
        }
        
        function previewOrderEditImage() {
            const img = document.getElementById('editOrderImagePreview');
            const url = document.getElementById('editOrderImage').value;
            img.src = url && url.startsWith('http') ? url : '';
            img.style.display = url ? 'block' : 'none';
        }
        
        function calculateOrderTotalCost() {
            const cost = parseFloat(document.getElementById('editOrderCost').value) || 0;
            const shipping = parseFloat(document.getElementById('editOrderShipping').value) || 0;
            const packingFee = parseFloat(document.getElementById('editPackingFee').value) || 0;
            const otherCosts = parseFloat(document.getElementById('editOrderOtherCosts').value) || 0;
            const totalCost = cost + shipping + packingFee + otherCosts;
            document.getElementById('editOrderTotalCost').value = totalCost.toFixed(2);
            calculateOrderProfit();
        }
        
        function calculateOrderProfit() {
            const amountPaid = parseFloat(document.getElementById('editAmountPaid').value) || 0;
            const totalCost = parseFloat(document.getElementById('editOrderTotalCost').value) || 0;
            const profit = amountPaid - totalCost;
            document.getElementById('editProfit').value = profit.toFixed(2);
        }
        
        function saveEditOrder() {
            const id = document.getElementById('editOrderId').value;
            const order = orders.find(o => o.id == id);
            if (!order) return;
            if (!document.getElementById('editPlatform').value || 
                !document.getElementById('editShop').value || 
                !document.getElementById('editOrderNumber').value || 
                !document.getElementById('editOrderName').value || 
                !document.getElementById('editOrderSku').value) {
                showNotification('请填写必填字段！', true);
                return;
            }
            order.platform = document.getElementById('editPlatform').value.trim();
            order.shop = document.getElementById('editShop').value.trim();
            order.orderDate = document.getElementById('editOrderDate').value;
            order.orderNumber = document.getElementById('editOrderNumber').value.trim();
            order.productName = document.getElementById('editOrderName').value.trim();
            order.sku = document.getElementById('editOrderSku').value.trim();
            order.image = document.getElementById('editOrderImage').value.trim();
            order.amountPaid = parseFloat(document.getElementById('editAmountPaid').value) || 0;
            order.cost = parseFloat(document.getElementById('editOrderCost').value) || 0;
            order.shipping = parseFloat(document.getElementById('editOrderShipping').value) || 0;
            order.packingFee = parseFloat(document.getElementById('editPackingFee').value) || 0;
            order.otherCosts = parseFloat(document.getElementById('editOrderOtherCosts').value) || 0;
            order.totalCost = parseFloat(document.getElementById('editOrderTotalCost').value) || 0;
            order.profit = parseFloat(document.getElementById('editProfit').value) || 0;
            order.courier = document.getElementById('editCourier').value.trim();
            order.trackingNumber = document.getElementById('editTrackingNumber').value.trim();
            order.notes = document.getElementById('editOrderNotes').value.trim();
            saveOrdersToLocalStorage();
            renderOrderTable();
            document.getElementById('editOrderModal').style.display = 'none';
            showNotification('订单更新成功！');
        }
        
        // 删除订单
        function deleteOrder(id) {
            if (!confirm('确定要删除这个订单吗？此操作不可恢复。')) return;
            const index = orders.findIndex(o => o.id == id);
            if (index !== -1) {
                orders.splice(index, 1);
                saveOrdersToLocalStorage();
                renderOrderTable();
                showNotification('订单已删除！');
            }
        }
        
        // 计算订单汇总
        function calculateOrderSummary(data) {
            const summary = {
                amountPaid: 0,
                cost: 0,
                shipping: 0,
                packingFee: 0,
                otherCosts: 0,
                totalCost: 0,
                profit: 0
            };
            
            data.forEach(order => {
                summary.amountPaid += parseFloat(order.amountPaid) || 0;
                summary.cost += parseFloat(order.cost) || 0;
                summary.shipping += parseFloat(order.shipping) || 0;
                summary.packingFee += parseFloat(order.packingFee) || 0;
                summary.otherCosts += parseFloat(order.otherCosts) || 0;
                summary.totalCost += parseFloat(order.totalCost) || 0;
                summary.profit += parseFloat(order.profit) || 0;
            });
            
            return summary;
        }
        
        // 渲染订单表格
        function renderOrderTable(data = orders) {
            filteredOrders = [...data];
            const tbody = document.querySelector('#orderTable tbody');
            tbody.innerHTML = '';
            const startIndex = (currentOrderPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageOrders = filteredOrders.slice(startIndex, endIndex);
            
            // 计算汇总
            const summary = calculateOrderSummary(filteredOrders);
            
            // 更新汇总栏
            document.getElementById('summaryAmountPaid').textContent = summary.amountPaid.toFixed(2);
            document.getElementById('summaryCost').textContent = summary.cost.toFixed(2);
            document.getElementById('summaryShipping').textContent = summary.shipping.toFixed(2);
            document.getElementById('summaryPackingFee').textContent = summary.packingFee.toFixed(2);
            document.getElementById('summaryOtherCosts').textContent = summary.otherCosts.toFixed(2);
            document.getElementById('summaryTotalCost').textContent = summary.totalCost.toFixed(2);
            document.getElementById('summaryProfit').textContent = summary.profit.toFixed(2);
            
            // 设置利润颜色
            const profitEl = document.getElementById('summaryProfit');
            profitEl.className = summary.profit >= 0 ? 'summary-value summary-profit' : 'summary-value summary-loss';
            
            if (pageOrders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="18" style="text-align: center; padding: 2rem;">没有找到订单数据</td></tr>`;
            } else {
                pageOrders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${order.platform}</td>
                        <td>${order.shop}</td>
                        <td>${order.orderDate}</td>
                        <td>${order.orderNumber}</td>
                        <td>${order.productName}</td>
                        <td>${order.sku}</td>
                        <td>
                            ${order.image ? 
                                `<img src="${order.image}" class="table-img" alt="${order.productName}">` : 
                                '<span style="color:#999">无图片</span>'}
                        </td>
                        <td>${order.amountPaid.toFixed(2)}</td>
                        <td>${order.cost.toFixed(2)}</td>
                        <td>${order.shipping.toFixed(2)}</td>
                        <td>${order.packingFee.toFixed(2)}</td>
                        <td>${order.otherCosts.toFixed(2)}</td>
                        <td>${order.totalCost.toFixed(2)}</td>
                        <td class="${order.profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                            ${order.profit >= 0 ? '+' : ''}${order.profit.toFixed(2)}
                        </td>
                        <td>${order.courier || '-'}</td>
                        <td>${order.trackingNumber || '-'}</td>
                        <td class="notes-cell">${order.notes || ''}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm" onclick="editOrder(${order.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.id})"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            renderOrderPagination();
            document.getElementById('orderItemCount').textContent = `显示 ${pageOrders.length} 条，共 ${filteredOrders.length} 条记录`;
        }
        
        // 渲染订单分页
        function renderOrderPagination() {
            const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            const paginationEl = document.getElementById('orderPagination');
            paginationEl.innerHTML = '';
            if (totalPages <= 1) return;
            const prevBtn = document.createElement('div');
            prevBtn.className = `page-btn ${currentOrderPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.onclick = () => {
                if (currentOrderPage > 1) {
                    currentOrderPage--;
                    renderOrderTable();
                }
            };
            paginationEl.appendChild(prevBtn);
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = `page-btn ${i === currentOrderPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentOrderPage = i;
                    renderOrderTable();
                };
                paginationEl.appendChild(pageBtn);
            }
            const nextBtn = document.createElement('div');
            nextBtn.className = `page-btn ${currentOrderPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.onclick = () => {
                if (currentOrderPage < totalPages) {
                    currentOrderPage++;
                    renderOrderTable();
                }
            };
            paginationEl.appendChild(nextBtn);
        }
        
        // 订单文件导入
        function handleOrderExcelImport(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    const requiredFields = ['平台', '店铺名', '订单日期', '订单号', '商品名称', 'SKU', '图片URL', '实付款', '成本', '运费', '打包费', '其他费用', '快递公司', '快递单号', '备注'];
                    const headers = Object.keys(json[0] || {});
                    const missingFields = requiredFields.filter(field => !headers.includes(field));
                    if (missingFields.length > 0) {
                        showNotification(`缺少必要字段: ${missingFields.join(', ')}`, true);
                        return;
                    }
                    const imported = json.map(item => ({
                        id: Date.now() + Math.random(),
                        platform: item['平台'] || '',
                        shop: item['店铺名'] || '',
                        orderDate: item['订单日期'] || new Date().toISOString().split('T')[0],
                        orderNumber: item['订单号'] || '',
                        productName: item['商品名称'] || '',
                        sku: item['SKU'] || '',
                        image: item['图片URL'] || '',
                        amountPaid: parseFloat(item['实付款']) || 0,
                        cost: parseFloat(item['成本']) || 0,
                        shipping: parseFloat(item['运费']) || 0,
                        packingFee: parseFloat(item['打包费']) || 0,
                        otherCosts: parseFloat(item['其他费用']) || 0,
                        totalCost: (parseFloat(item['成本']) + parseFloat(item['运费']) + parseFloat(item['打包费']) + parseFloat(item['其他费用'])) || 0,
                        profit: (parseFloat(item['实付款']) - (parseFloat(item['成本']) + parseFloat(item['运费']) + parseFloat(item['打包费']) + parseFloat(item['其他费用']))) || 0,
                        courier: item['快递公司'] || '',
                        trackingNumber: item['快递单号'] || '',
                        notes: item['备注'] || '',
                        createdAt: new Date().toISOString()
                    }));
                    orders = [...orders, ...imported];
                    saveOrdersToLocalStorage();
                    renderOrderTable();
                    showNotification(`成功导入 ${imported.length} 条订单数据！`);
                } catch (error) {
                    console.error('导入错误:', error);
                    showNotification('导入失败，请检查文件格式和内容', true);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 筛选订单
        function filterOrders() {
            const filterType = document.getElementById('filterType').value;
            const keyword = document.getElementById('orderSearchInput').value.trim().toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filtered = orders;
            
            // 按关键词筛选
            if (keyword) {
                filtered = filtered.filter(order => {
                    if (filterType === 'shop') {
                        return order.shop.toLowerCase().includes(keyword);
                    } else if (filterType === 'orderNumber') {
                        return order.orderNumber.toLowerCase().includes(keyword);
                    } else if (filterType === 'productName') {
                        return order.productName.toLowerCase().includes(keyword);
                    } else if (filterType === 'sku') {
                        return order.sku.toLowerCase().includes(keyword);
                    } else if (filterType === 'trackingNumber') {
                        return order.trackingNumber.toLowerCase().includes(keyword);
                    }
                    return true;
                });
            }
            
            // 按日期筛选
            if (startDate || endDate) {
                filtered = filtered.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    if (startDate && new Date(startDate) > orderDate) return false;
                    if (endDate && new Date(endDate) < orderDate) return false;
                    return true;
                });
            }
            
            currentOrderPage = 1;
            renderOrderTable(filtered);
            showNotification(`找到 ${filtered.length} 条匹配订单`);
        }
        
        // 查看全部订单
        function showAllOrders() {
            document.getElementById('orderSearchInput').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            currentOrderPage = 1;
            renderOrderTable();
            showNotification('显示全部订单数据');
        }
        
        // 导出订单到Excel（带汇总行）
        function exportOrdersToExcel(data, filename) {
            if (data.length === 0) {
                showNotification('没有数据可导出', true);
                return;
            }
            
            try {
                // 转换数据为工作表格式
                const worksheetData = data.map(o => ({
                    '平台': o.platform,
                    '店铺名': o.shop,
                    '订单日期': o.orderDate,
                    '订单号': o.orderNumber,
                    '商品名称': o.productName,
                    'SKU': o.sku,
                    '图片URL': o.image,
                    '实付款': o.amountPaid,
                    '成本': o.cost,
                    '运费': o.shipping,
                    '打包费': o.packingFee,
                    '其他费用': o.otherCosts,
                    '订单总成本': o.totalCost,
                    '利润': o.profit,
                    '快递公司': o.courier,
                    '快递单号': o.trackingNumber,
                    '备注': o.notes,
                    '创建时间': new Date(o.createdAt).toLocaleString()
                }));
                
                // 计算汇总
                const summary = calculateOrderSummary(data);
                
                // 添加汇总行
                worksheetData.push({
                    '平台': '汇总',
                    '店铺名': '',
                    '订单日期': '',
                    '订单号': '',
                    '商品名称': '',
                    'SKU': '',
                    '图片URL': '',
                    '实付款': summary.amountPaid,
                    '成本': summary.cost,
                    '运费': summary.shipping,
                    '打包费': summary.packingFee,
                    '其他费用': summary.otherCosts,
                    '订单总成本': summary.totalCost,
                    '利润': summary.profit,
                    '快递公司': '',
                    '快递单号': '',
                    '备注': `共 ${data.length} 条订单`,
                    '创建时间': ''
                });
                
                const ws = XLSX.utils.json_to_sheet(worksheetData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '订单列表');
                
                // 设置文件名
                const now = new Date();
                const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
                const timeStr = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
                const fileName = `${filename}_${dateStr}_${timeStr}.xlsx`;
                
                // 使用5+ API保存文件
                saveFileWith5Plus(wb, fileName);
            } catch (e) {
                console.error('导出错误:', e);
                showNotification('导出失败: ' + e.message, true);
            }
        }
        
        function exportAllOrders() { 
            exportOrdersToExcel(orders, '全部订单数据');
        }
        
        function exportFilteredOrders() {
            exportOrdersToExcel(filteredOrders, '筛选订单数据');
        }
        
        // ========== 通用功能 ==========
        // 使用5+ API保存文件
        function saveFileWith5Plus(wb, fileName) {
            // 将工作簿转换为二进制数据
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            
            if (window.plus) {
                // 5+ app环境
                const directory = plus.io.PUBLIC_DOWNLOADS;
                const filePath = directory + '/' + fileName;
                
                // 请求文件系统访问权限
                plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS, function(fs) {
                    fs.root.getFile(fileName, { create: true }, function(fileEntry) {
                        fileEntry.createWriter(function(writer) {
                            writer.onwrite = function(e) {
                                showNotification(`文件已保存到: ${filePath}`);
                            };
                            writer.onerror = function(e) {
                                showNotification('文件保存失败: ' + e.message, true);
                            };
                            
                            // 将ArrayBuffer转换为Blob
                            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            
                            // 写入文件
                            writer.write(blob);
                        }, function(e) {
                            showNotification('创建写入器失败: ' + e.message, true);
                        });
                    }, function(e) {
                        showNotification('创建文件失败: ' + e.message, true);
                    });
                }, function(e) {
                    showNotification('请求文件系统失败: ' + e.message, true);
                });
            } else {
                // 浏览器环境
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification(`文件 ${fileName} 已开始下载`);
            }
        }
        
        // 打开图片模态框
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImage = modal.querySelector('.modal-image');
            modalImage.src = src;
            modal.style.display = 'flex';
        }
        
        // 显示选择模态框
        function showSelection(type) {
            const modal = document.getElementById('selectionModal');
            const modalTitle = document.getElementById('modalTitle');
            const selectionBody = document.getElementById('selectionBody');
            let items = [];
            let title = '';
            
            if (type === 'name' || type === 'orderName') {
                title = '选择商品名称';
                items = [...new Set(products.map(p => p.name))];
            } else if (type === 'sku' || type === 'orderSku') {
                title = '选择SKU/规格';
                // 优化：根据商品名称过滤SKU
                const productName = type === 'orderSku' 
                    ? document.getElementById('orderProductName').value.trim()
                    : document.getElementById('productName').value.trim();
                
                if (productName) {
                    // 只显示当前商品名称下的SKU
                    items = [...new Set(products
                        .filter(p => p.name === productName)
                        .map(p => p.sku))];
                } else {
                    items = [...new Set(products.map(p => p.sku))];
                }
            } else if (type === 'shop') {
                title = '选择店铺名';
                items = [...new Set(orders.map(o => o.shop))];
            } else if (type === 'platform') {
                title = '选择平台';
                items = [...new Set(orders.map(o => o.platform))];
            }
            
            if (items.length === 0) {
                selectionBody.innerHTML = `<div style="text-align:center; padding:2rem; color:#666">没有可选项</div>`;
            } else {
                selectionBody.innerHTML = items.map(item => 
                    `<div class="selection-item" data-value="${item}">${item}</div>`
                ).join('');
                document.querySelectorAll('.selection-item').forEach(item => {
                    item.addEventListener('click', function() {
                        if (type === 'name') {
                            document.getElementById('productName').value = this.dataset.value;
                        } else if (type === 'sku') {
                            document.getElementById('productSku').value = this.dataset.value;
                        } else if (type === 'orderName') {
                            document.getElementById('orderProductName').value = this.dataset.value;
                            updateSkuOptions();
                            // 更新SKU自动补全列表
                            updateSkuAutocompleteByProductName(this.dataset.value);
                        } else if (type === 'orderSku') {
                            document.getElementById('orderSku').value = this.dataset.value;
                            populateCost();
                        }
                        modal.style.display = 'none';
                    });
                });
            }
            modalTitle.textContent = title;
            modal.style.display = 'flex';
        }
        
        // 根据商品名称更新SKU自动补全
        function updateSkuAutocompleteByProductName(productName) {
            const autocompleteList = document.getElementById('orderSkuAutocomplete');
            let skus = [];
            
            if (productName) {
                // 只获取当前商品名称下的SKU
                skus = [...new Set(products
                    .filter(p => p.name === productName)
                    .map(p => p.sku))];
            } else {
                skus = [...new Set(products.map(p => p.sku))];
            }
            
            autocompleteList.innerHTML = skus.map(sku => 
                `<div class="autocomplete-item" data-value="${sku}">${sku}</div>`
            ).join('');
            
            // 重新绑定事件
            autocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.getElementById('orderSku').value = this.dataset.value;
                    populateCost();
                });
            });
        }
        
        // 更新自动补全列表
        function updateAutocompleteLists() {
            // 商品自动补全
            const names = [...new Set(products.map(p => p.name))];
            const skus = [...new Set(products.map(p => p.sku))];
            const searchOptions = [...names, ...skus];
            document.getElementById('nameAutocomplete').innerHTML = names.map(name => 
                `<div class="autocomplete-item" data-value="${name}">${name}</div>`
            ).join('');
            document.getElementById('skuAutocomplete').innerHTML = skus.map(sku => 
                `<div class="autocomplete-item" data-value="${sku}">${sku}</div>`
            ).join('');
            document.getElementById('searchAutocomplete').innerHTML = searchOptions.map(opt => 
                `<div class="autocomplete-item" data-value="${opt}">${opt}</div>`
            ).join('');
            document.getElementById('editNameAutocomplete').innerHTML = names.map(name => 
                `<div class="autocomplete-item" data-value="${name}">${name}</div>`
            ).join('');
            document.getElementById('editSkuAutocomplete').innerHTML = skus.map(sku => 
                `<div class="autocomplete-item" data-value="${sku}">${sku}</div>`
            ).join('');
            
            // 订单自动补全
            const shops = [...new Set(orders.map(o => o.shop))];
            const platforms = [...new Set(orders.map(o => o.platform))];
            const orderNames = [...new Set(orders.map(o => o.productName))];
            const orderSkus = [...new Set(orders.map(o => o.sku))];
            const trackingNumbers = [...new Set(orders.map(o => o.trackingNumber))];
            const orderSearchOptions = [...shops, ...orderNames, ...orderSkus, ...trackingNumbers];
            
            document.getElementById('orderSearchAutocomplete').innerHTML = orderSearchOptions.map(opt => 
                `<div class="autocomplete-item" data-value="${opt}">${opt}</div>`
            ).join('');
            
            // 新增：订单录入部分的商品名称自动补全
            const orderNameAutocomplete = document.getElementById('orderNameAutocomplete');
            if (orderNameAutocomplete) {
                orderNameAutocomplete.innerHTML = names.map(name => 
                    `<div class="autocomplete-item" data-value="${name}">${name}</div>`
                ).join('');
            }
            
            // 新增：订单录入部分的SKU自动补全
            const orderSkuAutocomplete = document.getElementById('orderSkuAutocomplete');
            if (orderSkuAutocomplete) {
                orderSkuAutocomplete.innerHTML = skus.map(sku => 
                    `<div class="autocomplete-item" data-value="${sku}">${sku}</div>`
                ).join('');
            }
            
            // 编辑订单弹窗中的自动补全
            const editOrderNameAutocomplete = document.getElementById('editOrderNameAutocomplete');
            if (editOrderNameAutocomplete) {
                editOrderNameAutocomplete.innerHTML = names.map(name => 
                    `<div class="autocomplete-item" data-value="${name}">${name}</div>`
                ).join('');
            }
            
            const editOrderSkuAutocomplete = document.getElementById('editOrderSkuAutocomplete');
            if (editOrderSkuAutocomplete) {
                editOrderSkuAutocomplete.innerHTML = skus.map(sku => 
                    `<div class="autocomplete-item" data-value="${sku}">${sku}</div>`
                ).join('');
            }
            
            // 添加自动补全点击事件
            document.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    const input = this.closest('.autocomplete').querySelector('input');
                    const inputId = input.id;
                    input.value = this.dataset.value;
                    this.closest('.autocomplete').classList.remove('active');
                    
                    // 根据输入框ID执行后续操作
                    if (inputId === 'orderProductName') {
                        updateSkuOptions();
                        // 更新SKU自动补全列表
                        updateSkuAutocompleteByProductName(this.dataset.value);
                    } else if (inputId === 'orderSku') {
                        populateCost();
                    } else if (inputId === 'searchInput') {
                        filterProducts();
                    } else if (inputId === 'orderSearchInput') {
                        filterOrders();
                    } else if (inputId === 'editOrderName') {
                        updateOrderSkuOptions();
                    } else if (inputId === 'editOrderSku') {
                        populateOrderCost();
                    }
                });
            });
        }
        
        // 更新特定自动补全
        function updateAutocomplete(type, value) {
            let container;
            if (type === 'name') {
                container = document.getElementById('nameAutocomplete');
            } else if (type === 'sku') {
                container = document.getElementById('skuAutocomplete');
            } else if (type === 'search') {
                container = document.getElementById('searchAutocomplete');
            } else if (type === 'orderName') {
                container = document.getElementById('orderNameAutocomplete');
            } else if (type === 'orderSku') {
                container = document.getElementById('orderSkuAutocomplete');
            } else if (type === 'orderSearch') {
                container = document.getElementById('orderSearchAutocomplete');
            } else if (type === 'editOrderName') {
                container = document.getElementById('editOrderNameAutocomplete');
            } else if (type === 'editOrderSku') {
                container = document.getElementById('editOrderSkuAutocomplete');
            } else {
                container = document.getElementById(`${type}Autocomplete`);
            }
            
            if (!container) return;
            
            const items = container.querySelectorAll('.autocomplete-item');
            items.forEach(item => {
                if (item.dataset.value.toLowerCase().includes(value.toLowerCase())) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            container.parentElement.classList.toggle('active', value.length > 0);
        }
        
        // 显示通知
        function showNotification(message, isError = false, isInfo = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : isInfo ? 'info' : ''}`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 切换折叠状态
        function toggleCollapse(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.fa-chevron-down, .fa-chevron-right');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-right');
                }
            } else {
                content.classList.add('active');
                if (icon) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }
            }
        }
        
        // 在DOMContentLoaded事件中处理使用须知弹窗 
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否今天已经显示过弹窗
            const lastShownDate = localStorage.getItem('disclaimerLastShown');
            const today = new Date().toDateString();
            
            // 如果今天还没显示过，则显示弹窗
            if (lastShownDate !== today) {
                // 显示弹窗
                const disclaimerModal = document.getElementById('disclaimerModal');
                disclaimerModal.style.display = 'flex';
                
                // 设置倒计时
                let seconds = 3;
                const countdownElement = document.getElementById('countdown');
                const closeButton = document.getElementById('closeDisclaimerBtn');
                
                // 更新倒计时显示
                countdownElement.textContent = seconds;
                
                // 倒计时计时器
                const countdownInterval = setInterval(() => {
                    seconds--;
                    countdownElement.textContent = seconds;
                    
                    // 倒计时结束
                    if (seconds <= 0) {
                        clearInterval(countdownInterval);
                        closeButton.disabled = false;
                        closeButton.innerHTML = '关闭';
                    }
                }, 1000);
                
                // 关闭按钮事件
                closeButton.addEventListener('click', function() {
                    disclaimerModal.style.display = 'none';
                    // 记录今天已经显示过
                    localStorage.setItem('disclaimerLastShown', today);
                });
            }
        });
    </script>

    <!-- 在body底部添加使用须知弹窗 -->
    <div class="modal" id="disclaimerModal">
        <div class="disclaimer-content">
            <h2><i class="fas fa-info-circle"></i> 使用须知</h2>
            <div class="disclaimer-body">
                <ul>
                    <li>本软件基于web应用编写</li>
                    <li>本应用采用本地存储技术</li>
                    <li>由于web应用技术限制，软件数据建议您养成经常导出表格到本地备份，以免系统清理造成数据丢失</li>
                    <li>软件卸载前记得导出商品数据和订单数据备份，否则一但卸载数据将一同清理</li>
                    <li>本软件仅供学习交流，未经作者允许，盗用必究</li>
                </ul>
            </div>
            <div class="disclaimer-footer">
                <button id="closeDisclaimerBtn" class="btn btn-primary" disabled>关闭（<span id="countdown">3</span>秒后可用）</button>
            </div>
        </div>
    </div>
</body>
</html>
